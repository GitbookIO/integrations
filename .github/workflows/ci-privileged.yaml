name: CI - Privileged Integration Tests

on:
    workflow_run:
        # This workflow runs after the untrusted PR workflow completes successfully
        workflows: ['CI - Untrusted PR (Fork Safe)']
        types: [completed]
    workflow_dispatch:
        # Allow manual triggering for maintainers
        inputs:
            pr_number:
                description: 'PR number to test (optional)'
                required: false
                type: string

jobs:
    # Only run if the untrusted workflow succeeded
    integration-tests:
        if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'
        runs-on: ubuntu-latest
        name: Integration Tests
        # Use environment protection for additional security
        environment: integration-tests
        permissions:
            contents: read
            pull-requests: read
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version-file: 'package.json'

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Build
              run: bun run build

            - name: Setup 1Password CLI
              uses: ./.github/composite/setup-1password-op
              with:
                  OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}

            - name: Run integration tests
              run: bun run check
              env:
                  OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
                  # GitHub Files
                  UNFURL_GITHUB_CLIENT_ID: ${{ secrets.UNFURL_GITHUB_CLIENT_ID }}
                  UNFURL_GITHUB_CLIENT_SECRET: ${{ secrets.UNFURL_GITHUB_CLIENT_SECRET }}
                  # GitLab
                  GITLAB_CLIENT_ID: ${{ secrets.GITLAB_CLIENT_ID }}
                  GITLAB_CLIENT_SECRET: ${{ secrets.GITLAB_CLIENT_SECRET }}
                  # Discord
                  DISCORD_CLIENT_ID: ${{ secrets.DISCORD_CLIENT_ID }}
                  DISCORD_CLIENT_SECRET: ${{ secrets.DISCORD_CLIENT_SECRET }}
                  DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
                  # Slack
                  SLACK_CLIENT_ID: ${{ secrets.SLACK_STAGING_CLIENT_ID }}
                  SLACK_CLIENT_SECRET: ${{ secrets.SLACK_STAGING_CLIENT_SECRET }}
                  SLACK_SIGNING_SECRET: ${{ secrets.SLACK_STAGING_SIGNING_SECRET }}
                  # Figma
                  FIGMA_CLIENT_ID: ${{ secrets.FIGMA_STAGING_CLIENT_ID }}
                  FIGMA_CLIENT_SECRET: ${{ secrets.FIGMA_STAGING_CLIENT_SECRET }}
                  # Mailchimp
                  MAILCHIMP_CLIENT_ID: ${{ secrets.MAILCHIMP_STAGING_CLIENT_ID }}
                  MAILCHIMP_CLIENT_SECRET: ${{ secrets.MAILCHIMP_STAGING_CLIENT_SECRET }}
                  # Jira
                  JIRA_CLIENT_ID: ${{ secrets.JIRA_STAGING_CLIENT_ID }}
                  JIRA_CLIENT_SECRET: ${{ secrets.JIRA_STAGING_CLIENT_SECRET }}
                  # Linear
                  LINEAR_CLIENT_ID: ${{ secrets.LINEAR_STAGING_CLIENT_ID }}
                  LINEAR_CLIENT_SECRET: ${{ secrets.LINEAR_STAGING_CLIENT_SECRET }}
                  # Sentry
                  SENTRY_CLIENT_ID: ${{ secrets.SENTRY_STAGING_CLIENT_ID }}
                  SENTRY_CLIENT_SECRET: ${{ secrets.SENTRY_STAGING_CLIENT_SECRET }}
                  SENTRY_GITBOOK_INTEGRATION: ${{ secrets.SENTRY_STAGING_GITBOOK_INTEGRATION }}
                  # GitHub
                  GITHUB_APP_INSTALL_URL: ${{ secrets.GITBOOK_GITHUB_STAGING_APP_INSTALL_URL }}
                  GITHUB_APP_ID: ${{ secrets.GITBOOK_GITHUB_STAGING_APP_ID }}
                  GITHUB_CLIENT_ID: ${{ secrets.GITBOOK_GITHUB_STAGING_CLIENT_ID }}
                  GITHUB_CLIENT_SECRET: ${{ secrets.GITBOOK_GITHUB_STAGING_CLIENT_SECRET }}
                  GITHUB_WEBHOOK_SECRET: ${{ secrets.GITBOOK_GITHUB_STAGING_WEBHOOK_SECRET }}
                  GITHUB_PRIVATE_KEY: ${{ secrets.GITBOOK_GITHUB_STAGING_PRIVATE_KEY }}
                  # Lucid
                  LUCID_CLIENT_ID: ${{ secrets.LUCID_CLIENT_ID }}
                  LUCID_CLIENT_SECRET: ${{ secrets.LUCID_CLIENT_SECRET }}
                  # GitHub Copilot
                  GITHUBCOPILOT_APP_ID: ${{ secrets.GITHUBCOPILOT_STAGING_APP_ID }}
                  GITHUBCOPILOT_APP_URL: ${{ secrets.GITHUBCOPILOT_STAGING_APP_URL }}
                  GITHUBCOPILOT_CLIENT_ID: ${{ secrets.GITHUBCOPILOT_STAGING_CLIENT_ID }}
                  GITHUBCOPILOT_CLIENT_SECRET: ${{ secrets.GITHUBCOPILOT_STAGING_CLIENT_SECRET }}
